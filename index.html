<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paise de BRO | Multi-Trip & Simplify</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1;
            --secondary: #ec4899;
            --bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.75);
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --success: #10b981;
            --danger: #ef4444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }

        body {
            background-color: var(--bg);
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            color: var(--text);
            min-height: 100vh;
            padding: 2rem;
            overflow-x: hidden;
        }

        .container { max-width: 1200px; margin: 0 auto; }
        
        /* Layouts */
        .hidden { display: none !important; }
        .grid-layout { display: grid; grid-template-columns: 300px 1fr; gap: 2rem; }
        @media (max-width: 900px) { .grid-layout { grid-template-columns: 1fr; } }

        /* Cards */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        /* Typography */
        h1 { font-weight: 800; background: linear-gradient(to right, #818cf8, #f472b6); -webkit-background-clip: text; color: transparent; margin-bottom: 1rem;}
        h2, h3 { margin-bottom: 1rem; color: var(--text); }

        /* Inputs & Buttons */
        input, select {
            width: 100%; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1);
            padding: 0.75rem; border-radius: 8px; color: white; outline: none; margin-bottom: 10px;
        }
        button {
            width: 100%; padding: 0.75rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .btn-primary { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; }
        .btn-primary:hover { opacity: 0.9; transform: scale(1.02); }
        .btn-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: white; }

        /* Trip Selection Screen */
        .trip-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; }
        .trip-card { cursor: pointer; border: 1px solid rgba(255,255,255,0.05); }
        .trip-card:hover { border-color: var(--primary); transform: translateY(-5px); }

        /* Payment Optimization Section */
        .settlement-card {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .arrow-icon { color: var(--text-muted); margin: 0 10px; }

        /* Checkboxes */
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .checkbox-pill span {
            display: block; padding: 0.4rem 0.8rem; background: rgba(255,255,255,0.05);
            border-radius: 20px; font-size: 0.8rem; cursor: pointer; user-select: none;
            border: 1px solid transparent;
        }
        .checkbox-pill input:checked + span { background: var(--primary); border-color: var(--secondary); }
        .checkbox-pill input { display: none; }

        /* Lists */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <div class="container">
        
        <div id="tripSelectorView">
            <div style="text-align: center; margin-bottom: 3rem;">
                <h1 style="font-size: 3rem;">TripSplit Pro</h1>
                <p style="color: var(--text-muted);">Select a trip or create a new one to start splitting.</p>
            </div>

            <div class="card" style="max-width: 500px; margin: 0 auto 2rem auto;">
                <h3><i class="fas fa-suitcase"></i> Create New Trip</h3>
                <input type="text" id="newTripName" placeholder="Trip Name (e.g. Paris 2024)">
                <button class="btn-primary" onclick="createTrip()">Create Trip</button>
            </div>

            <div id="tripsList" class="trip-grid">
                </div>
        </div>

        <div id="dashboardView" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <div>
                    <button onclick="goHome()" class="btn-secondary" style="width: auto; padding: 5px 15px; font-size: 0.8rem; margin-bottom: 5px;">
                        <i class="fas fa-arrow-left"></i> All Trips
                    </button>
                    <h1 id="currentTripTitle" style="margin: 0;">Trip Name</h1>
                </div>
                <button class="btn-danger" style="width: auto;" onclick="deleteCurrentTrip()">
                    <i class="fas fa-trash"></i> Delete Trip
                </button>
            </div>

            <div class="grid-layout">
                <aside>
                    <div class="card">
                        <h3><i class="fas fa-users"></i> Travelers</h3>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="newTraveler" placeholder="Name">
                            <button class="btn-primary" style="width: auto;" onclick="addTraveler()"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="travelerList"></div>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-coins"></i> Currencies</h3>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="newCurrency" placeholder="Code (USD)">
                            <button class="btn-secondary" style="width: auto;" onclick="addCurrency()"><i class="fas fa-plus"></i></button>
                        </div>
                        <div id="currencyList" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 5px;"></div>
                    </div>

                    <div class="card" style="border-color: var(--success);">
                        <h3><i class="fas fa-magic"></i> Simplified Debts</h3>
                        <p style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 1rem;">
                            Follow these steps to settle all debts with minimum transactions.
                        </p>
                        <div id="simplifiedSettlements">
                            </div>
                    </div>
                </aside>

                <main>
                    <div class="card" style="display: flex; gap: 20px; align-items: center;">
                        <div style="flex: 1;">
                            <span style="color: var(--text-muted);">Total Cost</span>
                            <h2 id="totalCostDisplay">0.00</h2>
                        </div>
                        <div style="height: 100px; width: 100px;">
                            <canvas id="miniChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-receipt"></i> Add Expense</h3>
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px;">
                            <input type="text" id="descInput" placeholder="Description">
                            <input type="number" id="amountInput" placeholder="Amount">
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <select id="currencySelect"></select>
                            <select id="payerSelect"><option>Payer</option></select>
                        </div>

                        <label style="font-size: 0.85rem; color: var(--text-muted); display: block; margin: 10px 0 5px;">Split With:</label>
                        <div id="splitCheckboxes" class="checkbox-group"></div>

                        <button class="btn-primary" onclick="addExpense()">Add Expense</button>
                    </div>

                    <div class="card">
                        <h3>Recent Activity</h3>
                        <div id="expensesList"></div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, set } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // ðŸ”´ðŸ”´ FILL THIS IN ðŸ”´ðŸ”´
        const firebaseConfig = {
            apiKey: "YAIzaSyB1L79JF2HhJA_s7r_p3jsdMLi0tAYsTcc", 
            authDomain: "project008-d245d.firebaseapp.com",
            databaseURL: "https://project008-d245d-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "project008-d245d",
            storageBucket: "project008-d245d.appspot.com",
            messagingSenderId: "756575861094",
            appId: "1:756575861094:web:4d6c2db550cc016f3eb0a7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // State
        let currentTripId = null;
        let travelers = [];
        let expenses = [];
        let currencies = ['USD'];
        let chartInstance = null;

        // --- NAVIGATION ---
        window.createTrip = () => {
            const name = document.getElementById('newTripName').value;
            if(!name) return;
            const newRef = push(ref(db, 'trips'));
            set(newRef, { 
                meta: { name: name, created: Date.now() },
                currencies: { 'default': { code: 'USD' } } // Default currency
            });
            document.getElementById('newTripName').value = '';
        }

        window.loadTrip = (tripId, tripName) => {
            currentTripId = tripId;
            document.getElementById('tripSelectorView').classList.add('hidden');
            document.getElementById('dashboardView').classList.remove('hidden');
            document.getElementById('currentTripTitle').innerText = tripName;
            
            // Initialize Listeners for this specific trip
            listenToTripData();
        }

        window.goHome = () => {
            currentTripId = null;
            document.getElementById('dashboardView').classList.add('hidden');
            document.getElementById('tripSelectorView').classList.remove('hidden');
            // Remove listeners could be done here in a robust app, but okay for simple usage
            location.reload(); // Simple reload to clear state
        }

        window.deleteCurrentTrip = () => {
            if(confirm("Are you sure? This will delete all data for this trip.")) {
                remove(ref(db, `trips/${currentTripId}`));
                goHome();
            }
        }

        // --- ROOT LISTENER (Load all trips) ---
        onValue(ref(db, 'trips'), (snapshot) => {
            const data = snapshot.val();
            const list = document.getElementById('tripsList');
            list.innerHTML = '';
            
            if(data) {
                Object.entries(data).forEach(([key, val]) => {
                    const name = val.meta ? val.meta.name : 'Untitled Trip';
                    list.innerHTML += `
                        <div class="card trip-card" onclick="loadTrip('${key}', '${name}')">
                            <h3>${name}</h3>
                            <p style="color: var(--text-muted); font-size: 0.8rem;">Tap to manage</p>
                        </div>
                    `;
                });
            }
        });

        // --- TRIP SPECIFIC LOGIC ---

        function listenToTripData() {
            // 1. Travelers
            onValue(ref(db, `trips/${currentTripId}/travelers`), (snapshot) => {
                const data = snapshot.val();
                travelers = [];
                const list = document.getElementById('travelerList');
                const payer = document.getElementById('payerSelect');
                const checks = document.getElementById('splitCheckboxes');
                
                list.innerHTML = ''; payer.innerHTML = ''; checks.innerHTML = '';

                if(data) {
                    Object.entries(data).forEach(([k, v]) => {
                        travelers.push(v.name);
                        // Sidebar List
                        list.innerHTML += `<div class="list-item"><span>${v.name}</span> <i class="fas fa-times" style="cursor:pointer; color:var(--danger)" onclick="deleteItem('travelers/${k}')"></i></div>`;
                        // Payer Select
                        let opt = document.createElement('option'); opt.value = v.name; opt.innerText = v.name;
                        payer.appendChild(opt);
                        // Checkbox
                        checks.innerHTML += `
                            <label class="checkbox-pill">
                                <input type="checkbox" class="split-checkbox" value="${v.name}" checked>
                                <span>${v.name}</span>
                            </label>`;
                    });
                }
                recalc();
            });

            // 2. Currencies
            onValue(ref(db, `trips/${currentTripId}/currencies`), (snapshot) => {
                const data = snapshot.val();
                const list = document.getElementById('currencyList');
                const select = document.getElementById('currencySelect');
                list.innerHTML = ''; select.innerHTML = '';
                
                if(data) {
                    Object.entries(data).forEach(([k, v]) => {
                        list.innerHTML += `<span class="badge">${v.code} <span onclick="deleteItem('currencies/${k}')" style="cursor:pointer">&times;</span></span>`;
                        let opt = document.createElement('option'); opt.value = v.code; opt.innerText = v.code;
                        select.appendChild(opt);
                    });
                }
            });

            // 3. Expenses
            onValue(ref(db, `trips/${currentTripId}/expenses`), (snapshot) => {
                const data = snapshot.val();
                expenses = [];
                const list = document.getElementById('expensesList');
                list.innerHTML = '';
                let total = 0;

                if(data) {
                    Object.entries(data).reverse().forEach(([k, v]) => {
                        expenses.push(v);
                        total += v.amount;
                        list.innerHTML += `
                            <div class="list-item">
                                <div>
                                    <div style="font-weight:600">${v.desc}</div>
                                    <div style="font-size:0.8rem; color: var(--text-muted)">${v.payer} paid for ${v.involved.length}</div>
                                </div>
                                <div style="text-align:right">
                                    <div style="font-weight:bold; color: var(--secondary)">${v.currency} ${v.amount}</div>
                                    <i class="fas fa-trash" style="color:var(--danger); cursor:pointer; font-size:0.8rem;" onclick="deleteItem('expenses/${k}')"></i>
                                </div>
                            </div>
                        `;
                    });
                }
                document.getElementById('totalCostDisplay').innerText = total.toFixed(2);
                recalc();
                updateChart(expenses);
            });
        }

        // --- ACTIONS ---
        window.addTraveler = () => {
            const name = document.getElementById('newTraveler').value;
            if(name) {
                push(ref(db, `trips/${currentTripId}/travelers`), { name });
                document.getElementById('newTraveler').value = '';
            }
        }
        window.addCurrency = () => {
            const code = document.getElementById('newCurrency').value.toUpperCase();
            if(code) {
                push(ref(db, `trips/${currentTripId}/currencies`), { code });
                document.getElementById('newCurrency').value = '';
            }
        }
        window.addExpense = () => {
            const desc = document.getElementById('descInput').value;
            const amount = parseFloat(document.getElementById('amountInput').value);
            const currency = document.getElementById('currencySelect').value;
            const payer = document.getElementById('payerSelect').value;
            const involved = Array.from(document.querySelectorAll('.split-checkbox:checked')).map(cb => cb.value);

            if(desc && amount && payer && involved.length > 0) {
                push(ref(db, `trips/${currentTripId}/expenses`), {
                    desc, amount, currency, payer, involved, date: Date.now()
                });
                document.getElementById('descInput').value = '';
                document.getElementById('amountInput').value = '';
            }
        }
        window.deleteItem = (path) => {
            remove(ref(db, `trips/${currentTripId}/${path}`));
        }

        // --- ALGORITHMS ---

        function recalc() {
            if(expenses.length === 0 || travelers.length === 0) return;

            // 1. Calculate Raw Net Balances
            let balances = {};
            travelers.forEach(t => balances[t] = 0);

            expenses.forEach(ex => {
                const share = ex.amount / ex.involved.length;
                // Payer gets + (owed)
                if(balances[ex.payer] !== undefined) balances[ex.payer] += ex.amount;
                // Participants get - (owe)
                ex.involved.forEach(p => {
                    if(balances[p] !== undefined) balances[p] -= share;
                });
            });

            // 2. Simplify Debts (The Algorithm)
            const transactions = simplifyDebts(balances);
            renderSettlements(transactions);
        }

        function simplifyDebts(balances) {
            // Split into debtors and creditors
            let debtors = [];
            let creditors = [];

            Object.entries(balances).forEach(([name, amount]) => {
                // Use a small epsilon for float comparison to avoid 0.0000001 issues
                if(amount < -0.01) debtors.push({name, amount});
                if(amount > 0.01) creditors.push({name, amount});
            });

            // Sort by magnitude (optional but helps optimization)
            debtors.sort((a, b) => a.amount - b.amount);
            creditors.sort((a, b) => b.amount - a.amount);

            let transactions = [];

            // Greedy Matching
            let i = 0; // debtor index
            let j = 0; // creditor index

            while (i < debtors.length && j < creditors.length) {
                let debtor = debtors[i];
                let creditor = creditors[j];

                // The amount to settle is the minimum of what's owed vs what's owed TO
                let amount = Math.min(Math.abs(debtor.amount), creditor.amount);

                // Record transaction
                transactions.push({
                    from: debtor.name,
                    to: creditor.name,
                    amount: amount
                });

                // Adjust remaining balances
                debtor.amount += amount;
                creditor.amount -= amount;

                // If settled, move to next person
                if (Math.abs(debtor.amount) < 0.01) i++;
                if (creditor.amount < 0.01) j++;
            }

            return transactions;
        }

        function renderSettlements(transactions) {
            const container = document.getElementById('simplifiedSettlements');
            container.innerHTML = '';

            if(transactions.length === 0) {
                container.innerHTML = '<div style="text-align:center; opacity:0.5;">All settled up!</div>';
                return;
            }

            transactions.forEach(t => {
                container.innerHTML += `
                    <div class="settlement-card">
                        <div style="font-weight:600">${t.from}</div>
                        <div style="display:flex; flex-direction:column; align-items:center;">
                            <span style="font-size:0.7rem; color:var(--text-muted);">pays</span>
                            <i class="fas fa-long-arrow-alt-right arrow-icon"></i>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:600">${t.to}</div>
                            <div style="font-weight:bold; color:var(--success);">${t.amount.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            });
        }

        function updateChart(data) {
            const ctx = document.getElementById('miniChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Expenses'],
                    datasets: [{
                        data: [100], 
                        backgroundColor: ['#6366f1'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '70%', plugins: { legend: { display: false }, tooltip: { enabled: false } } }
            });
        }

    </script>
</body>
</html>
